<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8" />
    <title>Agenda TS Saúde</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <style>
        /* (Aqui mantive seu CSS exatamente igual, para não perder nada) */
        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        ul {
            list-style: none;
        }

        /* Header */
        header {
            background: #fff;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        header .logo {
            height: 40px;
        }

        header .top-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Main Layout */
        .scheduler-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 280px;
            background: #fff;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 1px 0 4px rgba(0, 0, 0, 0.1);
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .right-panel {
            width: 300px;
            background: #fff;
            padding: 20px;
            box-shadow: -1px 0 4px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar Calendar & Filters */
        .calendar {
            margin-bottom: 20px;
        }

        .calendar .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar table {
            width: 100%;
            border-collapse: collapse;
        }

        .calendar td {
            width: 14.28%;
            height: 40px;
            text-align: center;
            cursor: pointer;
        }

        .calendar td.selected {
            background: #4caf50;
            color: #fff;
            border-radius: 4px;
        }

        .filter-group {
            margin-top: 15px;
        }

        .filter-group label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 5px;
        }

        /* Main Scheduler */
        .schedule-list {
            padding: 20px;
        }

        .slot {
            background: #fff;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
        }

        .slot .time {
            width: 80px;
            padding: 15px;
            border-right: 1px solid #eee;
            font-weight: bold;
        }

        .slot .details {
            flex: 1;
            padding: 15px;
        }

        .slot.confirmed .time {
            background: #4caf50;
            color: #fff;
        }

        .slot.confirmed .details .status {
            background: #4caf50;
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .slot .actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 10px;
        }

        .slot .actions button {
            background: none;
            border: none;
            cursor: pointer;
        }

        .available-times {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* centraliza horizontalmente */
            justify-content: center;
            padding: 20px;
            background: #fff;
            margin: 20px auto;
            width: 50%;
            /* deixa centralizado no meio da tela */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .available-times h3 {
            margin-bottom: 10px;
        }

        .available-times select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
        }


        /* Right Panel */
        .panel-title {
            font-weight: bold;
            margin-bottom: 15px;
        }

        .panel-group {
            margin-bottom: 15px;
        }

        .panel-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .panel-group select,
        .panel-group input {
            width: 100%;
            padding: 5px;
        }
    </style>
</head>

<body>
    <header>
        <img src="/images/logo.png" alt="Logo" class="logo" />
        <div class="top-controls">
            <button onclick="prevDay()">&lt;</button>
            <span th:text="${selectedDate}"></span>
            <button onclick="nextDay()">&gt;</button>
            <select id="topFilterConvenio" onchange="applyFilters()">
                <option value="">Todos os Convênios</option>
                <option th:each="c : ${convenios}" th:value="${c.id}" th:text="${c.nome}"></option>
            </select>
            <input type="text" placeholder="Pesquisar por nome" id="searchName" oninput="filterSlots()" />
        </div>
    </header>

    <div class="scheduler-container">
        <aside class="sidebar">
            <!-- Calendário e filtros permanecem inalterados -->
            <div class="calendar">
                <div class="month-nav">
                    <button onclick="prevMonth()">&lt;</button>
                    <span th:text="${currentMonth}"></span>
                    <button onclick="nextMonth()">&gt;</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Dom</th>
                            <th>Seg</th>
                            <th>Ter</th>
                            <th>Qua</th>
                            <th>Qui</th>
                            <th>Sex</th>
                            <th>Sáb</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="week : ${calendarWeeks}">
                            <td th:each="day : ${week}" th:text="${day.day}"
                                th:classappend="${day.selected} ? 'selected' : ''" onclick="selectDate('${day.date}')">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div>
                <input type="checkbox" id="showFreeOnly" onchange="toggleFreeOnly()" />
                <label for="showFreeOnly">Apenas Livres</label>
            </div>
            <div class="filter-group">
                <label for="filterConvenio">Convênio</label>
                <select id="filterConvenio" onchange="applyFilters()">
                    <option value="">Todos</option>
                    <option th:each="c : ${convenios}" th:value="${c.id}" th:text="${c.nome}"></option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterEspecialidade">Especialidade</label>
                <select id="filterEspecialidade" onchange="applyFilters()">
                    <option value="">Todas as Especialidades</option>
                    <option th:each="e : ${especialidades}" th:value="${e.id}" th:text="${e.nome}"></option>
                </select>
            </div>

            <!-- Formulário para selecionar médico, data e horário -->
            <div class="filter-group">
                <label for="medicoSelect">Profissional (Médico)</label>
                <select id="medicoSelect" name="doctor.id" class="form-control" required>
                    <option value="" disabled selected>Selecione um médico</option>
                    <option th:each="m : ${doctors}" th:value="${m.id}" th:text="${m.fullName}"></option>
                </select>
            </div>
            <div class="filter-group">
                <label for="appointmentDate">Data</label>
                <input type="date" id="appointmentDate" name="appointmentDate" th:value="${selectedDate}" required />
            </div>
            <!-- <div class="filter-group">
                <label for="appointmentTime">Horário Disponível</label>
                <select id="appointmentTime" name="appointmentTime" required>
                    <option value="" disabled selected>Selecione um horário</option>
                   
                </select>
            </div> -->
        </aside>

        <!-- <section class="main">
            <div class="schedule-list" id="scheduleList">
                <div class="slot" th:each="slot : ${slots}" th:classappend="${slot.confirmado} ? ' confirmed' : ''">
                    <div class="time" th:text="${slot.hora}"></div>
                    <div class="details">
                        <div class="status" th:text="${slot.confirmado} ? 'CONFIRMADO' : 'LIVRE'"></div>
                        <div><strong th:text="${slot.pacienteNome}"></strong></div>
                        <div th:text="${slot.especialidade}"></div>
                    </div>
                    <div class="actions">
                        <button title="Editar" th:onclick="|editSlot(${slot.id})|">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button title="Cancelar" th:onclick="|cancelSlot(${slot.id})|">
                            <i class="fa fa-trash"></i>
                        </button>
                        <button title="Atender" th:onclick="|attendSlot(${slot.id})|">
                            <i class="fa fa-stethoscope"></i>
                        </button>
                    </div>
                    <div class="available-times">
                        <h3>Horários Disponíveis</h3>
                        <select id="appointmentTime" name="appointmentTime" required>
                            <option value="" disabled selected>Selecione um horário</option>
                        </select>
                    </div>

                </div>
            </div>
        </section> -->

        <section class="main">

            <!-- Horários Disponíveis sempre visíveis -->
            <div class="available-times">
                <h3>Horários Disponíveis</h3>
                <select id="appointmentTime" name="appointmentTime" required>
                    <option value="" disabled selected>Selecione um horário</option>
                </select>
            </div>

            <!-- Lista de slots -->
            <div class="schedule-list" id="scheduleList">
                <div class="slot" th:each="slot : ${slots}" th:classappend="${slot.confirmado} ? ' confirmed' : ''">
                    <div class="time" th:text="${slot.hora}"></div>
                    <div class="details">
                        <div class="status" th:text="${slot.confirmado} ? 'CONFIRMADO' : 'LIVRE'"></div>
                        <div><strong th:text="${slot.pacienteNome}"></strong></div>
                        <div th:text="${slot.especialidade}"></div>
                    </div>
                    <div class="actions">
                        <button title="Editar" th:onclick="|editSlot(${slot.id})|">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button title="Cancelar" th:onclick="|cancelSlot(${slot.id})|">
                            <i class="fa fa-trash"></i>
                        </button>
                        <button title="Atender" th:onclick="|attendSlot(${slot.id})|">
                            <i class="fa fa-stethoscope"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>


        <aside class="right-panel">
            <div class="panel-title">Painel Senhas</div>
            <div class="panel-group">
                <label for="roomSelect">Sala</label>
                <select id="roomSelect">
                    <option th:each="s : ${salas}" th:value="${s.id}" th:text="${s.nome}"></option>
                </select>
            </div>
            <div class="panel-group">
                <label>Grupo Fila Atendimento</label>
                <table>
                    <tr>
                        <td><input type="checkbox" id="padrao" /> <label for="padrao">PADRÃO</label></td>
                    </tr>
                </table>
                <button onclick="refreshPanel()"><i class="fa fa-sync"></i></button>
            </div>
        </aside>
    </div>

    <script>
        // Funções stub mantidas para compatibilidade
        function prevDay() { }
        function nextDay() { }
        function prevMonth() {
            const url = new URL(window.location.href);
            let month = parseInt(url.searchParams.get("month")) || (new Date().getMonth() + 1);
            let year = parseInt(url.searchParams.get("year")) || new Date().getFullYear();

            month--;
            if (month < 1) { month = 12; year--; }

            window.location.href = `/appointments/agenda?month=${month}&year=${year}`;
        }
        function nextMonth() {
            const url = new URL(window.location.href);
            let month = parseInt(url.searchParams.get("month")) || (new Date().getMonth() + 1);
            let year = parseInt(url.searchParams.get("year")) || new Date().getFullYear();

            month++;
            if (month > 12) { month = 1; year++; }

            window.location.href = `/appointments/agenda?month=${month}&year=${year}`;
        }
        function selectDate(date) {
            const medicoId = document.getElementById('medicoSelect').value;
            if (medicoId) {
                window.location.href = `/appointments/agenda?medicoId=${medicoId}&data=${date}`;
            } else {
                alert("Selecione um médico primeiro.");
            }
        }

        function applyFilters() { }
        function filterSlots() { }
        function editSlot(slotId) { }
        function cancelSlot(slotId) { }
        function attendSlot(slotId) { }
        function toggleFreeOnly() { }
        function refreshPanel() { }


        async function carregarHorariosDisponiveis() {
            const medicoSelect = document.getElementById('medicoSelect');
            const dataInput = document.getElementById('appointmentDate');
            const horarioSelect = document.getElementById('appointmentTime');

            const medicoId = medicoSelect.value;
            const data = dataInput.value;

            if (medicoId && data) {
                try {
                    const response = await fetch(`/appointments/horarios-disponiveis?medicoId=${medicoId}&data=${data}`);
                    if (!response.ok) throw new Error('Erro ao buscar horários');

                    const horarios = await response.json();

                    horarioSelect.innerHTML = '<option value="" disabled selected>Selecione um horário</option>';

                    if (horarios.length === 0) {
                        const option = document.createElement('option');
                        option.value = "";
                        option.text = "Nenhum horário disponível";
                        option.disabled = true;
                        horarioSelect.appendChild(option);
                    } else {
                        horarios.forEach(horario => {
                            const option = document.createElement('option');
                            option.value = horario;
                            option.text = horario;
                            horarioSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error(error);
                    horarioSelect.innerHTML = '<option value="" disabled selected>Erro ao carregar horários</option>';
                }
            } else {
                horarioSelect.innerHTML = '<option value="" disabled selected>Selecione médico e data</option>';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('medicoSelect').addEventListener('change', carregarHorariosDisponiveis);
            document.getElementById('appointmentDate').addEventListener('change', carregarHorariosDisponiveis);

            if (document.getElementById('medicoSelect').value && document.getElementById('appointmentDate').value) {
                carregarHorariosDisponiveis();
            }
        });

    </script>
</body>

</html>